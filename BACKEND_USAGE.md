# åç«¯ä½¿ç”¨è¯´æ˜æ–‡æ¡£ (Backend Guide)

æœ¬æ–‡æ¡£æ—¨åœ¨ä¸ºå‰ç«¯å¼€å‘äººå‘˜æä¾›åç«¯æœåŠ¡çš„è¿è¡Œã€æ¥å£è°ƒç”¨åŠé‰´æƒæœºåˆ¶è¯´æ˜ã€‚

## ğŸš€ å¿«é€Ÿå¯åŠ¨

åç«¯åº”ç”¨ä½äº `backend` ç›®å½•ï¼Œæ„å»ºäº§ç‰©ä¸º `target/hospital-1.0.0.jar`ã€‚

### 1. å¯åŠ¨å‘½ä»¤
åœ¨ `backend` ç›®å½•ä¸‹æ‰§è¡Œï¼š

```bash
# æ–¹å¼ä¸€ï¼šç›´æ¥è¿è¡Œ Jar åŒ… (æ¨è)
java -jar target/hospital-1.0.0.jar

# æ–¹å¼äºŒï¼šä½¿ç”¨ Maven è¿è¡Œ
mvn spring-boot:run
```

å¯åŠ¨æˆåŠŸåï¼Œæ§åˆ¶å°å°†è¾“å‡ºï¼š
> âœ… é£é©¬æ˜ŸçƒåŒ»é™¢é¢„çº¦æŒ‚å·ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼
> APIæ–‡æ¡£: http://localhost:8080/doc.html

### 2. ç¯å¢ƒè¦æ±‚
*   **JDK**: 17+
*   **MySQL**: 8.0+ (éœ€é¢„å…ˆå¯¼å…¥ `sql/init.sql` åŠ `sql/init_indexes.sql`)
*   **Redis**: 5.0+ (é»˜è®¤ç«¯å£ `6379`ï¼Œæ— å¯†ç )
*   **ç«¯å£**: é»˜è®¤å ç”¨ `8080`

---

## ğŸ”‘ è®¤è¯æœºåˆ¶ (é‡è¦å˜æ›´)

åç«¯å®‰å…¨å±‚å·²å…¨é¢å‡çº§ï¼Œè¯·å‰ç«¯å¯¹æ¥æ—¶æ³¨æ„ä»¥ä¸‹å˜æ›´ï¼š

### 1. ç™»å½•æ¥å£è¿”å›å€¼
åŸæœ¬è¿”å› `User` å¯¹è±¡ï¼Œç°æ”¹ä¸ºè¿”å› **Token å“åº”**ï¼š

*   **ç®¡ç†å‘˜ç™»å½•**: `POST /api/admin/login` (å‚æ•°: `userId`, `password`)
*   **æ‚£è€…ç™»å½•**: `POST /api/patient/login` (å‚æ•°: `userId`, `password`)
*   **æ‚£è€…æ³¨å†Œ**: `POST /api/patient/register`

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiJ9...",  // æœ‰æ•ˆæœŸ 15 åˆ†é’Ÿ
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9..." // æœ‰æ•ˆæœŸ 7 å¤©
  }
}
```

### 2. è¯·æ±‚å¤´è®¾ç½®
é™¤ç™»å½•/æ³¨å†Œå¤–çš„æ‰€æœ‰æ¥å£ï¼Œå‡éœ€åœ¨ HTTP Header ä¸­æºå¸¦ `accessToken`ï¼š

```http
Authorization: Bearer <accessToken>
```

### 3. Token åˆ·æ–°æœºåˆ¶
å½“æ¥å£è¿”å› `401 Unauthorized` æ—¶ï¼Œå‰ç«¯åº”å°è¯•ä½¿ç”¨ `refreshToken` è·å–æ–°çš„ `accessToken`ï¼š

*   **æ¥å£**: `POST /api/auth/refresh`
*   **å‚æ•°**: `{"refreshToken": "..."}`
*   **å“åº”**: è¿”å›æ–°çš„ Token å¯¹ã€‚

### 4. é€€å‡ºç™»å½•
*   **æ¥å£**: `POST /api/auth/logout`
*   **è¯´æ˜**: è°ƒç”¨åå½“å‰ Token ç«‹å³å¤±æ•ˆ (åŠ å…¥é»‘åå•)ã€‚

---

## ğŸ“š API æ–‡æ¡£

åç«¯é›†æˆäº† Knife4j (Swagger) æ–‡æ¡£ï¼Œå¯åŠ¨åè®¿é—®ï¼š

*   **æ–‡æ¡£åœ°å€**: [http://localhost:8080/doc.html](http://localhost:8080/doc.html)
*   **è°ƒè¯•å»ºè®®**: å¯åœ¨æ–‡æ¡£é¡µé¢çš„ "Authorize" æ å¡«å…¥ Token è¿›è¡Œæ¥å£è°ƒè¯•ã€‚

---

## ğŸ› ï¸ æ•°æ®åº“ä¸è´¦å·

*   **å¯†ç åŠ å¯†**: æ•°æ®åº“ä¸­çš„å¯†ç å·²å‡çº§ä¸º Bcrypt å“ˆå¸Œã€‚
    *   åº”ç”¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¿ç§»æ—§æ˜æ–‡å¯†ç ã€‚
    *   æµ‹è¯•è´¦å·ï¼ˆå¦‚ `admin` / `123456`ï¼‰å¯ç›´æ¥ä½¿ç”¨ï¼Œåç«¯ä¼šè‡ªåŠ¨åŒ¹é…ã€‚
*   **æ€§èƒ½ä¼˜åŒ–**: å·²æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

## âš ï¸ å¸¸è§é—®é¢˜

1.  **å¯åŠ¨æŠ¥é”™ Bean å†²çª**ï¼šè¯·ç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç ï¼Œå·²åœ¨ `SecurityConfig` ä¸­ä¿®å¤äº† Bean å‘½åå†²çªã€‚

---

## ğŸ§ª E2E æµ‹è¯•æ¡†æ¶

é¡¹ç›®é›†æˆäº† **Playwright** ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºæ¨¡æ‹Ÿç”¨æˆ·çœŸå®æ“ä½œéªŒè¯ç³»ç»ŸåŠŸèƒ½ã€‚

### 1. æµ‹è¯•èŒƒå›´
*   **src/test/java/com/pegasus/hospital/e2e/**
    *   `PatientAppointmentTest`: æ‚£è€…æ³¨å†Œã€ç™»å½•ã€æŸ¥è¯¢åŒ»ç”Ÿã€é¢„çº¦æµç¨‹ã€‚
    *   `DoctorWorkstationTest`: åŒ»ç”Ÿç™»å½•ã€æŸ¥çœ‹å¾…è¯Šåˆ—è¡¨ã€‚
    *   `AdminDataImportTest`: ç®¡ç†å‘˜å¯¼å…¥åŒ»ç”Ÿæ•°æ®ã€‚

### 2. è¿è¡Œæµ‹è¯•
è¿è¡Œ E2E æµ‹è¯•éœ€è¦å‰ç«¯æœåŠ¡å·²å¯åŠ¨å¹¶å¯è®¿é—® (é»˜è®¤ `http://localhost:5173`)ã€‚

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯• (åŒ…å«å•å…ƒæµ‹è¯•å’Œ E2E)
mvn test

# ä»…è¿è¡Œ E2E æµ‹è¯•
mvn test -Dtest=com.pegasus.hospital.e2e.**

# æŒ‡å®šå‰ç«¯åœ°å€è¿è¡Œ
mvn test -Dtest=PatientAppointmentTest -DbaseUrl=http://your-frontend-url
```

### 3. ç¯å¢ƒå‡†å¤‡
é¦–æ¬¡è¿è¡Œ Playwright æµ‹è¯•æ—¶ï¼ŒMaven ä¼šè‡ªåŠ¨å°è¯•ä¸‹è½½æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œï¼š
```bash
mvn exec:java -e -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install"
```

---

## ğŸ“Š ç›‘æ§ä½“ç³»

é¡¹ç›®é›†æˆäº† **Prometheus + Grafana** ç›‘æ§æ ˆï¼Œæä¾›å®æ—¶ç³»ç»ŸçŠ¶æ€ç›‘æ§ã€‚

### 1. å¯åŠ¨ç›‘æ§æ ˆ
```bash
# éœ€è¦ Docker æƒé™
sudo docker-compose -f docker-compose-monitoring.yml up -d
```
> **æ³¨æ„**: å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼Œè¯·ä½¿ç”¨ `sudo` æˆ–ç¡®ä¿å½“å‰ç”¨æˆ·åœ¨ `docker` ç»„ä¸­ã€‚
å¯åŠ¨åè®¿é—®ï¼š
*   **Prometheus**: [http://localhost:9090](http://localhost:9090)
*   **Grafana**: [http://localhost:3000](http://localhost:3000) (é»˜è®¤è´¦å· `admin` / `admin`)

### 2. å…³é”®æŒ‡æ ‡
*   **ä¸šåŠ¡æŒ‡æ ‡**:
    *   `appointments.total`: é¢„çº¦æ€»é‡ï¼ˆæŒ‰çŠ¶æ€ç»Ÿè®¡ï¼‰
    *   `schedule.available_slots`: åŒ»ç”Ÿæ’ç­å‰©ä½™å·æº
*   **ç³»ç»ŸæŒ‡æ ‡**: JVM å†…å­˜ã€GCã€CPUã€æ•°æ®åº“è¿æ¥æ± ç­‰ (Actuator æ ‡å‡†æŒ‡æ ‡)

### 3. æŸ¥çœ‹æŒ‡æ ‡
è®¿é—® Spring Boot Actuator ç«¯ç‚¹ï¼š
[http://localhost:8080/actuator/prometheus](http://localhost:8080/actuator/prometheus)
